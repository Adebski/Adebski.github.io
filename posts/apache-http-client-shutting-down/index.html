<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>A case of Apache HTTP client becoming unusable due to java.lang.OutOfMemoryError - ItDepends</title>
<meta name=description content="ItDepends is a blog about various topics related to software engineering."><link rel=alternate type=application/rss+xml href=https://blog.adebski.com/posts/apache-http-client-shutting-down/index.xml title=ItDepends><link rel=icon type=image/x-icon href=https://blog.adebski.com/favicon.ico><link rel=apple-touch-icon-precomposed href=https://blog.adebski.com/favicon.png><link rel=stylesheet href="https://blog.adebski.com/css/style.css?rnd=1741363171"><meta property="og:url" content="https://blog.adebski.com/posts/apache-http-client-shutting-down/"><meta property="og:site_name" content="ItDepends"><meta property="og:title" content="A case of Apache HTTP client becoming unusable due to java.lang.OutOfMemoryError"><meta property="og:description" content="This post describes a problem where an instance of the Apache HTTP client becomes unusable if the JVM throws a java.lang.Error when executing the library code and possible ways of dealing with that situation."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-27T00:00:00+00:00"><meta property="article:modified_time" content="2021-02-27T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="A case of Apache HTTP client becoming unusable due to java.lang.OutOfMemoryError"><meta name=twitter:description content="This post describes a problem where an instance of the Apache HTTP client becomes unusable if the JVM throws a java.lang.Error when executing the library code and possible ways of dealing with that situation."><link rel=stylesheet href=https://blog.adebski.com/css/overrides.min.46bddf09875384022135fff5ebb739c4af83bf8632f1d38d3835320f379b8af8.css><script type=text/javascript src=https://blog.adebski.com/js/codeCopy.min.5353c462b0d40da2e3105de29e7877252c1ab2d82333d9869aa4127f1905a690.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-891PSZFW6E"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-891PSZFW6E")</script><link rel=alternate type=application/rss+xml href=https://blog.adebski.com//index.xml title="ItDepends Feed"></head><body><a class=skip-main href=#main>Skip to main content</a><div class=container><header><div class=site-header-div><h1 class=site-header><a href=/>ItDepends</a></h1><nav><a href=https://blog.adebski.com/posts/ title>Archive</a>
<a href=https://blog.adebski.com/about/ title>About</a></nav></div></header><main id=main tabindex=-1><aside><nav id=TableOfContents><ol><li><a href=#problem-description>Problem description</a></li><li><a href=#the-solution>The solution</a></li><li><a href=#reproducing-the-problem>Reproducing the problem</a></li></ol></nav></aside><article class=post><header><h1 class=post-title>A case of Apache HTTP client becoming unusable due to java.lang.OutOfMemoryError</h1></header><div class=content><p>This post describes a problem where an instance of the Apache HTTP client becomes unusable if the JVM throws a <code>java.lang.Error</code>
when executing the library code and possible ways of dealing with that situation.</p><h1 id=problem-description>Problem description</h1><p><a href=https://hc.apache.org/index.html>Apache HTTP libraries</a> are widely used in the JVM ecosystem, some examples include <a href=https://github.com/aws/aws-sdk-java/blob/c491416f3ea9411a04d9bafedee6c6874a79e48d/aws-java-sdk-core/pom.xml#L22>the official AWS SDK</a>, <a href=https://github.com/spring-projects/spring-framework/blob/c084936870bbe47b4e6d403d8106265e89fbc7cc/build.gradle#L158>Spring Framework</a>, <a href="https://github.com/apache/hadoop/search?l=Maven+POM&amp;q=org.apache.httpcomponents">Hadoop</a>, and many more.
They are often used as building blocks by other libraries and frameworks to handle low-level details of the HTTP protocol.</p><p>At one point in time, &ldquo;my&rdquo; team was responsible for a data aggregation pipeline that aggregated data from multiple tables present in a proprietary data store and saved those aggregations in S3. Systems downstream of that data store could be notified about saves to specific tables by subscribing their SQS queues to a notification stream produced by that data store. The data aggregation pipeline polled the SQS queue and when a new save notification arrived the data was loaded in memory and saved in S3.
Due to the number of saves to that datastore, the application was deployed on multiple servers and it relied on SQS to distribute the work between the nodes/workers. We could assume that a single row in the data store won&rsquo;t change after the initial write and it wasn&rsquo;t an issue if the data aggregations in S3 would contain a &ldquo;small&rdquo; number of duplicated entries.</p><figure><img src=/img/apache-http-client-shutting-down/architecture.svg alt="High level architecture diagram"><figcaption><p>High level architecture diagram</p></figcaption></figure><p>We&rsquo;ve routinely observed that every couple of weeks some of the nodes would stop processing the messages correctly, either by not being able to consume messages from SQS or failing to fetch the data from the data store. In both cases, the logs were filled with the following exception suggesting that something wrong was happening with the Apache HTTP client used internally by both AWS SDK and a client library used to interact with the data store.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>IllegalStateException</span>: Connection pool shut down
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>Asserts</span>.<span style=color:#a6e22e>check</span>(Asserts.<span style=color:#a6e22e>java</span>:34) 
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>AbstractConnPool</span>.<span style=color:#a6e22e>lease</span>(AbstractConnPool.<span style=color:#a6e22e>java</span>:191)
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>PoolingHttpClientConnectionManager</span>.<span style=color:#a6e22e>requestConnection</span>(PoolingHttpClientConnectionManager.<span style=color:#a6e22e>java</span>:267) 
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>execchain</span>.<span style=color:#a6e22e>MainClientExec</span>.<span style=color:#a6e22e>execute</span>(MainClientExec.<span style=color:#a6e22e>java</span>:176) 
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>execchain</span>.<span style=color:#a6e22e>ProtocolExec</span>.<span style=color:#a6e22e>execute</span>(ProtocolExec.<span style=color:#a6e22e>java</span>:185) 
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>execchain</span>.<span style=color:#a6e22e>RetryExec</span>.<span style=color:#a6e22e>execute</span>(RetryExec.<span style=color:#a6e22e>java</span>:89)
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>execchain</span>.<span style=color:#a6e22e>RedirectExec</span>.<span style=color:#a6e22e>execute</span>(RedirectExec.<span style=color:#a6e22e>java</span>:110) 
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>InternalHttpClient</span>.<span style=color:#a6e22e>doExecute</span>(InternalHttpClient.<span style=color:#a6e22e>java</span>:185) 
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>CloseableHttpClient</span>.<span style=color:#a6e22e>execute</span>(CloseableHttpClient.<span style=color:#a6e22e>java</span>:83) 
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>CloseableHttpClient</span>.<span style=color:#a6e22e>execute</span>(CloseableHttpClient.<span style=color:#a6e22e>java</span>:108) 
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>CloseableHttpClient</span>.<span style=color:#a6e22e>execute</span>(CloseableHttpClient.<span style=color:#a6e22e>java</span>:56) </span></span></code></pre></td></tr></table></div></div><p>Based on the exception message we&rsquo;ve investigated a possibility that the application process was being shut down but with a very long timeout or that something was preventing the full shutdown altogether (for whatever reason). After inspecting application logs and looking at dates and times of deployments and system restarts we could not find any evidence of an external actor initiating the JVM shutdown process.</p><p>After ruling out a possibility of an actual shutdown happening we&rsquo;ve started to read the source code of the Apache HTTP client to understand under what conditions the connection pool shuts down.
It turned out that there exists logic inside the library that shuts down the pool if an instance of
<a href=(https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Error.html)><code>java.lang.Error</code></a> is thrown when
preparing the request, sending it, and receiving a response from the server.
Here is an excerpt from the <a href=https://github.com/apache/httpcomponents-client/blob/4.5.x/httpclient/src/main/java/org/apache/http/impl/execchain/MainClientExec.java#L150><code>org.apache.http.impl.execchain.MainClientExec#execute</code></a> method:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> CloseableHttpResponse <span style=color:#a6e22e>execute</span>(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> HttpRoute route,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> HttpRequestWrapper request,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> HttpClientContext context,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> HttpExecutionAware execAware) <span style=color:#66d9ef>throws</span> IOException, HttpException {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Acquire a connection to use for executing the request</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> ConnectionHolder connHolder <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConnectionHolder(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>log</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>connManager</span>, managedConn);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Send the request and receive the response</span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#66d9ef>final</span> ConnectionShutdownException ex) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> InterruptedIOException ioex <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> InterruptedIOException(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;Connection has been shut down&#34;</span>);
</span></span><span style=display:flex><span>        ioex.<span style=color:#a6e22e>initCause</span>(ex);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> ioex;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#66d9ef>final</span> HttpException ex) {
</span></span><span style=display:flex><span>        connHolder.<span style=color:#a6e22e>abortConnection</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> ex;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#66d9ef>final</span> IOException ex) {
</span></span><span style=display:flex><span>        connHolder.<span style=color:#a6e22e>abortConnection</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (proxyAuthState.<span style=color:#a6e22e>isConnectionBased</span>()) {
</span></span><span style=display:flex><span>            proxyAuthState.<span style=color:#a6e22e>reset</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (targetAuthState.<span style=color:#a6e22e>isConnectionBased</span>()) {
</span></span><span style=display:flex><span>            targetAuthState.<span style=color:#a6e22e>reset</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> ex;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#66d9ef>final</span> RuntimeException ex) {
</span></span><span style=display:flex><span>        connHolder.<span style=color:#a6e22e>abortConnection</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (proxyAuthState.<span style=color:#a6e22e>isConnectionBased</span>()) {
</span></span><span style=display:flex><span>            proxyAuthState.<span style=color:#a6e22e>reset</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (targetAuthState.<span style=color:#a6e22e>isConnectionBased</span>()) {
</span></span><span style=display:flex><span>            targetAuthState.<span style=color:#a6e22e>reset</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> ex;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#66d9ef>final</span> Error error) {
</span></span><span style=display:flex><span>        connManager.<span style=color:#a6e22e>shutdown</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> error;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div><p>We can see that the code catches different types of exceptions but it also catches instances of <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Error.html><code>java.lang.Error</code></a>. Both <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Exception.html><code>java.lang.Exception</code></a> and <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Error.html><code>java.lang.Error</code></a> classes are defined in the Java standard library and both of them extend from the top-level class for any things that can be thrown, <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Throwable.html><code>java.lang.Throwable</code></a>. The difference is that an error &ldquo;indicates serious problems that a reasonable application should not try to catch&rdquo; (based on the <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Error.html>Java docs</a>), things like <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/LinkageError.html><code>java.lang.LinkageError</code></a> or <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/StackOverflowError.html><code>java.lang.StackOverflowError</code></a>. Once we&rsquo;ve figured out that the connection pool could be shut down if a subclass of <code>java.lang.Error</code> was thrown by the JVM during HTTP request processing we understood what was happening.</p><figure><img src=/img/apache-http-client-shutting-down/exceptions.svg alt="Java exception hierarchy"><figcaption><p>Java exception hierarchy</p></figcaption></figure><p>On a side note, that <code>catch (final Error error)</code> clause was introduced as part of the <a href=https://github.com/apache/httpcomponents-client/commit/ca98ad69adad79de57d8b944ba524f7267a795cb>HTTPCLIENT-1924</a> in the <a href=https://github.com/apache/httpcomponents-client/blob/4.5.x/RELEASE_NOTES.txt#L257><code>4.5.6</code></a> version of the library.</p><p>To lower the fleet cost we&rsquo;ve made an operational decision in the past to allow situations where the rate of messages added to the queue was higher than the rate of messages consumed and processed by the fleet. We could do that because the aggregations in S3 could be behind the live data by hours or days and the volume of messages sent to the SQS queue from the data store depended on the time of day (more messages during the day, fewer messages during the night). Even if messages accumulated during the day the surplus was processed in the night.</p><p>Sometimes when the nodes were processing messages at their full capacity the memory pressure on the system was too high (e.g. too many threads trying to load too much data in memory) and <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/OutOfMemoryError.html><code>java.lang.OutOfMemoryError</code></a> was thrown by the JVM. On the high level, we did not have any problem with that, even if a processing thread was terminated and a message was not processed by this specific node we relied on an SQS mechanism called <a href=https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-visibility-timeout.html>visibility timeout</a> to process the same message on another consumer.
In the worst-case scenario, the same message would be processed twice and there would be some duplication in the aggregated data set but, as mentioned before, that situation was acceptable. We did not expect though that some components in the system would stop working altogether if they encountered an error like that.</p><h1 id=the-solution>The solution</h1><p>Once we understood the problem we decided to pass the <a href=https://www.oracle.com/java/technologies/javase/8u92-relnotes.html><code>-XX:+ExitOnOutOfMemoryError</code></a> option to the JVM process. It instructs the JVM to exit on the first occurrence of an out-of-memory error. In our case, the JVM processes were managed by a supervisor that would restart them if they crash or exit by themselves. Even if a process was processing some SQS messages they would be picked up again after the visibility timeout period. That was a quick and easy fix to the problem in our case.</p><p>Some alternative approaches come to my mind if we could not kill the processes without breaking some of the business requirements:</p><ol><li>Implement a wrapper around the client libraries that use Apache HTTP under the hood. That wrapper would handle the <code>java.lang.Error</code>s and replace old clients with new clients.</li><li>Scale the fleet, horizontally or vertically, to decrease the memory pressure on individual hosts.</li><li>Implement a dynamic backpressure mechanism based on heap memory occupancy or recent GC activity. Hosts would dynamically decrease the speed
of their processing to not end up with <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/OutOfMemoryError.html><code>java.lang.OutOfMemoryError</code></a> thrown during message processing.</li></ol><h1 id=reproducing-the-problem>Reproducing the problem</h1><p>I&rsquo;ve tried to prepare an example that would reproduce the problem described above using the client/server architecture. The full source code is available <a href=https://github.com/Adebski/ApacheHTTPClientOOM>on my GitHub</a>.</p><p>The server uses a not very well-known (from my experience) part of the Java standard library, <a href=https://docs.oracle.com/en/java/javase/11/docs/api/jdk.httpserver/com/sun/net/httpserver/HttpServer.html><code>com.sun.net.httpserver.HttpServer</code></a>. Despite having the <code>sun</code> in the package name it&rsquo;s <a href=https://stackoverflow.com/questions/58764710/is-package-com-sun-net-httpserver-standard>a part of the standard library</a>.
The server listens on a local interface on the port <code>12345</code> and implements two operations, <code>randomNumberOfHeaders</code> and <code>noAdditionalHeadersHandler</code>. The first operation returns a String <code>Response</code> for every request and additionally sends an increasing number of HTTP headers in the response.
I&rsquo;ve settled on this strategy to allow the client JVM to warm up and then gradually construct bigger and bigger responses that will trigger a <code>java.lang.OutOfMemoryError</code> on the client-side when receiving an HTTP response. <code>noAdditionalHeadersHandler</code> just returns a string <code>Response</code> in the response with no extra headers.</p><p>Initially, I wanted to construct responses with bigger and bigger response body but it turns out that the Apache HTTP client does not load the response body to memory automatically, instead the client code needs to consume it in a form of <code>java.io.InputStream</code>. Consuming bigger
and bigger response bodies generated <code>java.lang.OutOfMemoryError</code> but it originated not in the Apache HTTP library itself but in the code written
by me and did not result in the connection pool shutdown.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RandomNumberOfHeadersHandler</span> <span style=color:#66d9ef>implements</span> HttpHandler {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> AtomicInteger NUMBER_OF_HEADERS <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicInteger(100);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handle</span>(HttpExchange t) <span style=color:#66d9ef>throws</span> IOException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> number_of_headers <span style=color:#f92672>=</span> NUMBER_OF_HEADERS.<span style=color:#a6e22e>addAndGet</span>(10);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (number_of_headers <span style=color:#f92672>%</span> 100 <span style=color:#f92672>==</span> 0) {
</span></span><span style=display:flex><span>            logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;NUMBER_OF_HEADERS is {}&#34;</span>, number_of_headers);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> number_of_headers; <span style=color:#f92672>++</span>i) {
</span></span><span style=display:flex><span>            t.<span style=color:#a6e22e>getResponseHeaders</span>().<span style=color:#a6e22e>add</span>(<span style=color:#e6db74>&#34;Header-&#34;</span> <span style=color:#f92672>+</span> i, String.<span style=color:#a6e22e>valueOf</span>(number_of_headers));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        String response <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Response&#34;</span>;
</span></span><span style=display:flex><span>        t.<span style=color:#a6e22e>sendResponseHeaders</span>(200, response.<span style=color:#a6e22e>length</span>());
</span></span><span style=display:flex><span>        OutputStream os <span style=color:#f92672>=</span> t.<span style=color:#a6e22e>getResponseBody</span>();
</span></span><span style=display:flex><span>        os.<span style=color:#a6e22e>write</span>(response.<span style=color:#a6e22e>getBytes</span>());
</span></span><span style=display:flex><span>        os.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>} </span></span></code></pre></td></tr></table></div></div><p>The client spawns multiple threads, each thread uses Apache HTTP client to call the <code>randomNumberOfHeaders</code> operation in an &ldquo;infinite&rdquo; loop until
<code>java.lang.IllegalStateException</code> is received which indicates that a thread caught <code>java.lang.OutOfMemoryError</code>
and shut down the connection manager. After catching <code>java.lang.IllegalStateException</code> one last request is made to confirm that the client is now unusable. Any other exception will be logged and the infinite loop will continue.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>workerThreadLogic</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// We will loop infinitely until we receive IllegalStateException indicating that the library has shut down</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// the connection pool</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>true</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            HttpGet request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpGet(RANDOM_NUMBER_OF_HEADERS_ADDRESS);
</span></span><span style=display:flex><span>            HttpResponse response <span style=color:#f92672>=</span> CLIENT.<span style=color:#a6e22e>execute</span>(request);
</span></span><span style=display:flex><span>            <span style=color:#75715e>// We need to consume the response in order to release the connection in the pool maintained</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// by the Apache client library</span>
</span></span><span style=display:flex><span>            EntityUtils.<span style=color:#a6e22e>consume</span>(response.<span style=color:#a6e22e>getEntity</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            Thread.<span style=color:#a6e22e>sleep</span>(ThreadLocalRandom.<span style=color:#a6e22e>current</span>().<span style=color:#a6e22e>nextInt</span>(150));
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (IllegalStateException e) {
</span></span><span style=display:flex><span>            logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Illegal state exception received, stopping the loop&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (Throwable t) {
</span></span><span style=display:flex><span>            logger.<span style=color:#a6e22e>info</span>(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;Exception other than IllegalStateException received, logging and retrying the connection&#34;</span>,
</span></span><span style=display:flex><span>                t);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        HttpGet request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpGet(RANDOM_NUMBER_OF_HEADERS_ADDRESS);
</span></span><span style=display:flex><span>        request.<span style=color:#a6e22e>setConfig</span>(
</span></span><span style=display:flex><span>            RequestConfig.<span style=color:#a6e22e>custom</span>().<span style=color:#a6e22e>setSocketTimeout</span>(1000000).<span style=color:#a6e22e>build</span>()
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>        CLIENT.<span style=color:#a6e22e>execute</span>(request);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Last request&#34;</span>, e);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>} </span></span></code></pre></td></tr></table></div></div><p>And here is an example output from the Client execution. I&rsquo;ve explicitly specified <code>-Xms9m -Xmx9m</code> to set the heap size to (roughly) 9MB out of the box. As you can see it took around 5 seconds to get to a state where <code>java.lang.OutOfMemoryError</code> was thrown.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>adebski<span style=color:#a6e22e>@adebski</span><span style=color:#f92672>-</span>VirtualBox:<span style=color:#f92672>~/</span>IdeaProjects<span style=color:#f92672>/</span>ApacheHTTPClientOOM$ java <span style=color:#f92672>-</span>Xms9m <span style=color:#f92672>-</span>Xmx9m <span style=color:#f92672>-</span>cp target<span style=color:#f92672>/</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span> com.<span style=color:#a6e22e>adebski</span>.<span style=color:#a6e22e>Client</span>
</span></span><span style=display:flex><span>WARNING: sun.<span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Reflection</span>.<span style=color:#a6e22e>getCallerClass</span> is not supported. This will impact performance.
</span></span><span style=display:flex><span>22:31:47.<span style=color:#a6e22e>306</span> <span style=color:#f92672>[</span>main<span style=color:#f92672>]</span> INFO  com.<span style=color:#a6e22e>adebski</span>.<span style=color:#a6e22e>Client</span> <span style=color:#f92672>-</span> PID 18173
</span></span><span style=display:flex><span>22:31:52.<span style=color:#a6e22e>254</span> <span style=color:#f92672>[</span>WorkerThread<span style=color:#f92672>-</span>0<span style=color:#f92672>]</span> INFO  com.<span style=color:#a6e22e>adebski</span>.<span style=color:#a6e22e>Client</span> <span style=color:#f92672>-</span> Illegal state exception received, stopping the loop
</span></span><span style=display:flex><span>22:31:52.<span style=color:#a6e22e>254</span> <span style=color:#f92672>[</span>WorkerThread<span style=color:#f92672>-</span>1<span style=color:#f92672>]</span> INFO  com.<span style=color:#a6e22e>adebski</span>.<span style=color:#a6e22e>Client</span> <span style=color:#f92672>-</span> Illegal state exception received, stopping the loop
</span></span><span style=display:flex><span>22:31:52.<span style=color:#a6e22e>255</span> <span style=color:#f92672>[</span>WorkerThread<span style=color:#f92672>-</span>3<span style=color:#f92672>]</span> INFO  org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>execchain</span>.<span style=color:#a6e22e>RetryExec</span> <span style=color:#f92672>-</span> I<span style=color:#f92672>/</span>O <span style=color:#a6e22e>exception</span> (org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ConnectionClosedException</span>) caught when processing request to {}<span style=color:#f92672>-&gt;</span>http:<span style=color:#75715e>//localhost:12345: Connection is closed</span>
</span></span><span style=display:flex><span>22:31:52.<span style=color:#a6e22e>257</span> <span style=color:#f92672>[</span>WorkerThread<span style=color:#f92672>-</span>3<span style=color:#f92672>]</span> INFO  org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>execchain</span>.<span style=color:#a6e22e>RetryExec</span> <span style=color:#f92672>-</span> Retrying request to {}<span style=color:#f92672>-&gt;</span>http:<span style=color:#75715e>//localhost:12345</span>
</span></span><span style=display:flex><span>22:31:52.<span style=color:#a6e22e>257</span> <span style=color:#f92672>[</span>WorkerThread<span style=color:#f92672>-</span>3<span style=color:#f92672>]</span> INFO  com.<span style=color:#a6e22e>adebski</span>.<span style=color:#a6e22e>Client</span> <span style=color:#f92672>-</span> Illegal state exception received, stopping the loop
</span></span><span style=display:flex><span>22:31:52.<span style=color:#a6e22e>253</span> <span style=color:#f92672>[</span>WorkerThread<span style=color:#f92672>-</span>2<span style=color:#f92672>]</span> INFO  com.<span style=color:#a6e22e>adebski</span>.<span style=color:#a6e22e>Client</span> <span style=color:#f92672>-</span> Exception other than IllegalStateException received, logging and retrying the connection
</span></span><span style=display:flex><span>java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>OutOfMemoryError</span>: Java heap space
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>execchain</span>.<span style=color:#a6e22e>MainClientExec</span>.<span style=color:#a6e22e>execute</span>(MainClientExec.<span style=color:#a6e22e>java</span>:272) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>execchain</span>.<span style=color:#a6e22e>ProtocolExec</span>.<span style=color:#a6e22e>execute</span>(ProtocolExec.<span style=color:#a6e22e>java</span>:185) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>execchain</span>.<span style=color:#a6e22e>RetryExec</span>.<span style=color:#a6e22e>execute</span>(RetryExec.<span style=color:#a6e22e>java</span>:89) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>execchain</span>.<span style=color:#a6e22e>RedirectExec</span>.<span style=color:#a6e22e>execute</span>(RedirectExec.<span style=color:#a6e22e>java</span>:110) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>InternalHttpClient</span>.<span style=color:#a6e22e>doExecute</span>(InternalHttpClient.<span style=color:#a6e22e>java</span>:185) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>CloseableHttpClient</span>.<span style=color:#a6e22e>execute</span>(CloseableHttpClient.<span style=color:#a6e22e>java</span>:83) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>CloseableHttpClient</span>.<span style=color:#a6e22e>execute</span>(CloseableHttpClient.<span style=color:#a6e22e>java</span>:108) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>CloseableHttpClient</span>.<span style=color:#a6e22e>execute</span>(CloseableHttpClient.<span style=color:#a6e22e>java</span>:56) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at com.<span style=color:#a6e22e>adebski</span>.<span style=color:#a6e22e>Client</span>.<span style=color:#a6e22e>workerThreadLogic</span>(Client.<span style=color:#a6e22e>java</span>:70) <span style=color:#f92672>[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at com.<span style=color:#a6e22e>adebski</span>.<span style=color:#a6e22e>Client$$Lambda$102</span><span style=color:#f92672>/</span>0x000000084017cc40.<span style=color:#a6e22e>run</span>(Unknown Source) <span style=color:#f92672>[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>Thread</span>.<span style=color:#a6e22e>run</span>(Thread.<span style=color:#a6e22e>java</span>:834) <span style=color:#f92672>[?</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>22:31:52.<span style=color:#a6e22e>255</span> <span style=color:#f92672>[</span>WorkerThread<span style=color:#f92672>-</span>0<span style=color:#f92672>]</span> ERROR com.<span style=color:#a6e22e>adebski</span>.<span style=color:#a6e22e>Client</span> <span style=color:#f92672>-</span> Last request
</span></span><span style=display:flex><span>java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>IllegalStateException</span>: Connection pool shut down
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>22:31:52.<span style=color:#a6e22e>260</span> <span style=color:#f92672>[</span>WorkerThread<span style=color:#f92672>-</span>3<span style=color:#f92672>]</span> ERROR com.<span style=color:#a6e22e>adebski</span>.<span style=color:#a6e22e>Client</span> <span style=color:#f92672>-</span> Last request
</span></span><span style=display:flex><span>java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>IllegalStateException</span>: Connection pool shut down
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>22:31:52.<span style=color:#a6e22e>255</span> <span style=color:#f92672>[</span>WorkerThread<span style=color:#f92672>-</span>1<span style=color:#f92672>]</span> ERROR com.<span style=color:#a6e22e>adebski</span>.<span style=color:#a6e22e>Client</span> <span style=color:#f92672>-</span> Last request
</span></span><span style=display:flex><span>java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>IllegalStateException</span>: Connection pool shut down
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>22:31:52.<span style=color:#a6e22e>262</span> <span style=color:#f92672>[</span>WorkerThread<span style=color:#f92672>-</span>2<span style=color:#f92672>]</span> INFO  com.<span style=color:#a6e22e>adebski</span>.<span style=color:#a6e22e>Client</span> <span style=color:#f92672>-</span> Illegal state exception received, stopping the loop
</span></span><span style=display:flex><span>22:31:52.<span style=color:#a6e22e>263</span> <span style=color:#f92672>[</span>WorkerThread<span style=color:#f92672>-</span>2<span style=color:#f92672>]</span> ERROR com.<span style=color:#a6e22e>adebski</span>.<span style=color:#a6e22e>Client</span> <span style=color:#f92672>-</span> Last request
</span></span><span style=display:flex><span>java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>IllegalStateException</span>: Connection pool shut down
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>Asserts</span>.<span style=color:#a6e22e>check</span>(Asserts.<span style=color:#a6e22e>java</span>:34) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>AbstractConnPool</span>.<span style=color:#a6e22e>lease</span>(AbstractConnPool.<span style=color:#a6e22e>java</span>:191) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>PoolingHttpClientConnectionManager</span>.<span style=color:#a6e22e>requestConnection</span>(PoolingHttpClientConnectionManager.<span style=color:#a6e22e>java</span>:267) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>execchain</span>.<span style=color:#a6e22e>MainClientExec</span>.<span style=color:#a6e22e>execute</span>(MainClientExec.<span style=color:#a6e22e>java</span>:176) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>execchain</span>.<span style=color:#a6e22e>ProtocolExec</span>.<span style=color:#a6e22e>execute</span>(ProtocolExec.<span style=color:#a6e22e>java</span>:185) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>execchain</span>.<span style=color:#a6e22e>RetryExec</span>.<span style=color:#a6e22e>execute</span>(RetryExec.<span style=color:#a6e22e>java</span>:89) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>execchain</span>.<span style=color:#a6e22e>RedirectExec</span>.<span style=color:#a6e22e>execute</span>(RedirectExec.<span style=color:#a6e22e>java</span>:110) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>InternalHttpClient</span>.<span style=color:#a6e22e>doExecute</span>(InternalHttpClient.<span style=color:#a6e22e>java</span>:185) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>CloseableHttpClient</span>.<span style=color:#a6e22e>execute</span>(CloseableHttpClient.<span style=color:#a6e22e>java</span>:83) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>CloseableHttpClient</span>.<span style=color:#a6e22e>execute</span>(CloseableHttpClient.<span style=color:#a6e22e>java</span>:108) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>CloseableHttpClient</span>.<span style=color:#a6e22e>execute</span>(CloseableHttpClient.<span style=color:#a6e22e>java</span>:56) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at com.<span style=color:#a6e22e>adebski</span>.<span style=color:#a6e22e>Client</span>.<span style=color:#a6e22e>workerThreadLogic</span>(Client.<span style=color:#a6e22e>java</span>:91) <span style=color:#f92672>~[</span>ApacheHTTPClientOOM<span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>jar<span style=color:#f92672>-</span>with<span style=color:#f92672>-</span>dependencies.<span style=color:#a6e22e>jar</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>    at java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>Thread</span>.<span style=color:#a6e22e>run</span>(Thread.<span style=color:#a6e22e>java</span>:834) <span style=color:#f92672>[?</span>:<span style=color:#f92672>?]</span>
</span></span><span style=display:flex><span>22:31:52.<span style=color:#a6e22e>264</span> <span style=color:#f92672>[</span>main<span style=color:#f92672>]</span> INFO  com.<span style=color:#a6e22e>adebski</span>.<span style=color:#a6e22e>Client</span> <span style=color:#f92672>-</span> Expected exception received<span style=color:#f92672>!</span></span></span></code></pre></td></tr></table></div></div></div><div class=post-info><div class=post-date>2021-02-27</div><div class=post-taxonomies></div></div></article><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//ItDepends.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main><footer><p>Powered by <a target=_blank href=https://gohugo.io/>Hugo</a>, theme <a target=_blank href=https://github.com/mitrichius/hugo-theme-anubis>Anubis</a>.</p></footer></div></body></html>